#include <zmk/display/widgets/output_status.h>
#include <zmk/display/widgets/battery_status.h>
#include <zmk/display/widgets/layer_status.h>
#include <zmk/display/widgets/wpm_status.h>
#include <zmk/display/status_screen.h>

#include <logging/log.h>
LOG_MODULE_DECLARE(zmk, CONFIG_ZMK_LOG_LEVEL);

static lv_obj_t *zmk_widget_anim_img;

// Definição dos frames da animação do CatJAM (código da animação permanece o mesmo)
static const uint8_t cat_jam_data[][42] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x80, 0xc0, 0xe0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf8, 0xf0, 0xe0},
    {0x01, 0x03, 0x07, 0x0f, 0x1f, 0x3f, 0x7f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x1f, 0x0f,
     0x07, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfc, 0xf8, 0xf0,
     0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03,
     0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc0, 0x80, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
};

const void *get_anim_frame(int wpm) {
    wpm /= 10;
    switch(wpm) {
        case 0: return cat_jam_data[0];
        case 1: case 2: return cat_jam_data[1];
        case 3: case 4: return cat_jam_data[2];
        case 5: case 6: case 7: return cat_jam_data[3];
        default: return cat_jam_data[4];
    }
}

int anim_widget_update_cb(struct zmk_widget_wpm *widget, lv_obj_t *wpm_label) {
    int wpm = zmk_wpm_get_state();
    const void *frame = get_anim_frame(wpm);
    if (zmk_widget_anim_img != NULL) {
        lv_img_set_src(zmk_widget_anim_img, frame);
    }
    return 0;
}
ZMK_DISPLAY_WIDGET_LISTENER(anim_widget, zmk_wpm_state_changed, anim_widget_update_cb, ZMK_WIDGET_WPM_POS)


// --- NOVA FUNÇÃO DE LAYOUT DA TELA ---
#if IS_ENABLED(CONFIG_ZMK_DISPLAY)
static void set_status_screen(lv_obj_t *screen) {
    // Canto superior esquerdo: Status da Camada
    lv_obj_t *layer_status_widget = zmk_widget_layer_status_create(screen);
    lv_obj_align(layer_status_widget, NULL, LV_ALIGN_IN_TOP_LEFT, 2, 0);

    // Canto inferior esquerdo: Status da Bateria
    lv_obj_t *battery_status_widget = zmk_widget_battery_status_create(screen);
    lv_obj_align(battery_status_widget, NULL, LV_ALIGN_IN_BOTTOM_LEFT, 2, 0);

    // Lado direito: Animação
    zmk_widget_anim_img = lv_img_create(screen, NULL);
    lv_obj_align(zmk_widget_anim_img, NULL, LV_ALIGN_IN_RIGHT_MID, -2, 0);
}

// Função que o ZMK chama para construir a tela. Ela chama nossa função de layout.
lv_obj_t *zmk_display_status_screen() {
    lv_obj_t *screen;
    screen = lv_obj_create(NULL, NULL);
    set_status_screen(screen);
    return screen;
}
#endif
